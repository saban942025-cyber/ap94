"use client";
import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation"; 
import { db } from "../../../lib/firebase"; 
import { collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc, setDoc, deleteDoc } from "firebase/firestore";
import { Send, User, Package, CheckCircle, Trash2, List, MessageSquare, Truck, Check, LogOut, MapPin, FileText, Plus, Copy, Phone, Briefcase, Hash, Image as ImageIcon, FileSignature, Loader2, X, Clock, Box, ArrowLeftRight, UserCheck, Star, Users, UserCog, Mail, Eye, EyeOff, Lock, Link, Bell, BellOff, Search, Edit, Minus, Tag, AlertTriangle, HelpCircle, Split, ChevronUp } from "lucide-react"; 
import SignatureCanvas from 'react-signature-canvas';
import { PDFDocument, rgb } from 'pdf-lib';
import fontkit from '@pdf-lib/fontkit'; 

const GAS_URL = "https://script.google.com/macros/s/AKfycbwa7Xr1FtH7u_WV0cPSk2ap7JC9KcPjbQNt6XV3ojzZDaPhJ-zCVYmLJvdRWW5nbdpG/exec";

// --- ×”×’×“×¨×•×ª ---
const STATUS_COLORS: any = { "new": "bg-blue-100 text-blue-800 border-blue-200", "processing": "bg-orange-100 text-orange-800 border-orange-200", "shipped": "bg-purple-100 text-purple-800 border-purple-200", "delivered": "bg-green-100 text-green-800 border-green-200" };
const STATUS_LABELS: any = { "new": "×”×ª×§×‘×œ", "processing": "×‘×”×›× ×”", "shipped": "×‘×“×¨×š", "delivered": "× ××¡×¨" };

// --- ×××©×§×™× ---
interface Product { id: string; sku: string; name: string; category: string; imageUrl?: string; stock: number; }
interface OrderItem { name: string; quantity: number; sku: string; productId?: string; }
interface AmbiguousItem { originalText: string; quantity: number; options: Product[]; }
interface Message { id: string; text: string; sender: "client" | "server"; timestamp: any; type: "text" | "image" | "file" | "location"; fileUrl?: string; location?: {lat: number, lng: number}; staffName?: string; staffRole?: string; staffAvatar?: string; isInternal?: boolean; }
interface Client { id: string; name: string; clientNumber: string; projectName?: string; phone: string; avatarUrl?: string; }
interface SavedOrder { id: string; clientId: string; clientName: string; items: OrderItem[]; status: string; timestamp: any; signedPdfUrl?: string; }
interface StaffMember { id: string; name: string; role: string; phone: string; email: string; avatarUrl: string; }

export default function StaffDashboard() {
  const router = useRouter(); 
  const [activeTab, setActiveTab] = useState<"chat" | "orders" | "team" | "inventory">("chat");
  
  // × ×ª×•× ×™×
  const [clients, setClients] = useState<Client[]>([]);
  const [staffMembers, setStaffMembers] = useState<StaffMember[]>([]);
  const [inventory, setInventory] = useState<Product[]>([]);
  const [currentUser, setCurrentUser] = useState<StaffMember | null>(null);
  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);
  
  // ××¦×‘×™ ×××©×§
  const [isInternalMode, setIsInternalMode] = useState(false);
  const [soundEnabled, setSoundEnabled] = useState(true); 
  const isFirstLoad = useRef(true);
  const prevMessagesLength = useRef(0);

  // ××•×“×œ×™×
  const [showAddClientModal, setShowAddClientModal] = useState(false);
  const [showAddStaffModal, setShowAddStaffModal] = useState(false);
  const [showSmartListModal, setShowSmartListModal] = useState(false);
  const [showAddProductModal, setShowAddProductModal] = useState(false);
  const [showStatusModal, setShowStatusModal] = useState(false);
  const [selectedStoryOrder, setSelectedStoryOrder] = useState<SavedOrder | null>(null);

  // ×˜×¤×¡×™×
  const [newClientName, setNewClientName] = useState("");
  const [newClientNumber, setNewClientNumber] = useState("");
  const [newProjectName, setNewProjectName] = useState("");
  const [newClientPhone, setNewClientPhone] = useState("");
  const [newClientAvatar, setNewClientAvatar] = useState("");
  const [newStaffName, setNewStaffName] = useState("");
  const [newStaffRole, setNewStaffRole] = useState("");
  const [newStaffPhone, setNewStaffPhone] = useState("");
  const [newStaffEmail, setNewStaffEmail] = useState("");
  const [newStaffAvatar, setNewStaffAvatar] = useState("");
  const [newProdName, setNewProdName] = useState("");
  const [newProdSku, setNewProdSku] = useState("");
  const [newProdCategory, setNewProdCategory] = useState("");
  const [newProdStock, setNewProdStock] = useState("");
  const [newProdImage, setNewProdImage] = useState("");
  const [smartListSearch, setSmartListSearch] = useState("");

  const [messages, setMessages] = useState<Message[]>([]);
  const [ordersList, setOrdersList] = useState<SavedOrder[]>([]);
  const [reply, setReply] = useState("");
  const [chatSuggestions, setChatSuggestions] = useState<Product[]>([]); 
  const [detectedOrder, setDetectedOrder] = useState<OrderItem[]>([]); 
  const [ambiguousItems, setAmbiguousItems] = useState<AmbiguousItem[]>([]);
  
  // ×—×ª×™××” ×•-PDF
  const [showSignModal, setShowSignModal] = useState(false);
  const [pdfToSign, setPdfToSign] = useState<File | null>(null);
  const [isSigning, setIsSigning] = useState(false);
  const sigCanvas = useRef<any>({});
  const [currentOrderIdForSign, setCurrentOrderIdForSign] = useState<string | null>(null);
  const [logistics, setLogistics] = useState({ unloadingStart: "", unloadingEnd: "", waitingStart: "", waitingEnd: "", craneStart: "", craneEnd: "", craneType: "none", retBigBag: "", retBarrel: "", retPallet: "", retBlockPallet: "", retOther: "", credBigBag: "", credBarrel: "", credPallet: "", credBlockPallet: "", credOther: "", repName: "" });
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // --- Hooks ---
  useEffect(() => { const isAuth = localStorage.getItem("saban_staff_auth"); if (isAuth !== "true") { router.push("/staff/login"); } else { const storedStaff = localStorage.getItem("saban_staff_data"); if (storedStaff) setCurrentUser(JSON.parse(storedStaff)); } if (Notification.permission !== "granted") Notification.requestPermission(); }, []);
  const handleLogout = () => { localStorage.removeItem("saban_staff_auth"); localStorage.removeItem("saban_staff_id"); localStorage.removeItem("saban_staff_data"); router.push("/staff/login"); };

  // --- Firebase Listeners ---
  useEffect(() => { const q = query(collection(db, "clients"), orderBy("clientNumber")); const unsubscribe = onSnapshot(q, (snapshot) => { setClients(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as Client[]); }); return () => unsubscribe(); }, []);
  useEffect(() => { const qOrders = query(collection(db, "orders"), orderBy("timestamp", "desc")); const unsubOrders = onSnapshot(qOrders, (snapshot) => { setOrdersList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as SavedOrder[]); }); return () => unsubOrders(); }, []);
  useEffect(() => { const q = query(collection(db, "staff")); const unsubscribe = onSnapshot(q, (snapshot) => { setStaffMembers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as StaffMember[]); }); return () => unsubscribe(); }, []);
  useEffect(() => { const q = query(collection(db, "inventory"), orderBy("name")); const unsubscribe = onSnapshot(q, (snapshot) => { setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as Product[]); }); return () => unsubscribe(); }, []);

  // --- Chat Logic ---
  useEffect(() => { if (!selectedClientId) return; setDetectedOrder([]); setAmbiguousItems([]); prevMessagesLength.current = 0; const q = query(collection(db, `chats/${selectedClientId}/messages`), orderBy("timestamp", "asc")); const unsubscribe = onSnapshot(q, (snapshot) => { const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as Message[]; if (prevMessagesLength.current === 0 && msgs.length > 0) { prevMessagesLength.current = msgs.length; setMessages(msgs); setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100); return; } if (msgs.length > prevMessagesLength.current) { const newMessages = msgs.slice(prevMessagesLength.current); const clientMsg = newMessages.find(m => m.sender === 'client'); if (clientMsg) { playNotificationSound(); if (clientMsg.type === 'text') { analyzeOrder(clientMsg.text); } } } setMessages(msgs); prevMessagesLength.current = msgs.length; setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100); }); return () => unsubscribe(); }, [selectedClientId, inventory]);

  const playNotificationSound = () => { const audio = new Audio('/notification.mp3'); audio.onerror = () => setSoundEnabled(false); audio.play().then(() => setSoundEnabled(true)).catch(() => setSoundEnabled(false)); if (Notification.permission === "granted") new Notification("×”×•×“×¢×” ×—×“×©×” ××¡×‘×Ÿ", { body: "×œ×§×•×— ×©×œ×— ×”×•×“×¢×” ×‘×¦'××˜!", icon: "/logo.png" }); };
  const enableSound = () => { const audio = new Audio('/notification.mp3'); audio.play().then(() => setSoundEnabled(true)).catch(() => alert("×©×’×™××” ×‘×”×¤×¢×œ×ª ×¡××•× ×“")); };

  const handleChatInputChange = (text: string) => { setReply(text); if (text.length < 2) { setChatSuggestions([]); return; } const matches = inventory.filter(p => p.name.toLowerCase().includes(text.toLowerCase()) || p.sku.includes(text)).slice(0, 5); setChatSuggestions(matches); };
  const selectChatSuggestion = (product: Product) => { setReply(`10 ${product.name}`); setChatSuggestions([]); };

  const analyzeOrder = (text: string) => { const items: OrderItem[] = []; const ambiguities: AmbiguousItem[] = []; let remainingText = text.toLowerCase(); const sortedInventory = [...inventory].sort((a, b) => b.name.length - a.name.length); sortedInventory.forEach(prod => { const requiredWords = prod.name.toLowerCase().split(' ').filter(w => w.length > 1); const allWordsPresent = requiredWords.every(word => remainingText.includes(word)); if (allWordsPresent) { const regexQuantity = /(\d+)/; const match = remainingText.match(regexQuantity); if (match) { items.push({ name: prod.name, quantity: parseInt(match[0]), sku: prod.sku, productId: prod.id }); requiredWords.forEach(word => { remainingText = remainingText.replace(word, ' '.repeat(word.length)); }); remainingText = remainingText.replace(match[0], ' '.repeat(match[0].length)); } } }); const potentialMatches = inventory.filter(prod => { const words = prod.name.toLowerCase().split(' ').filter(w => w.length > 2); return words.some(word => remainingText.includes(word)); }); if (potentialMatches.length > 0) { const quantityMatch = remainingText.match(/(\d+)/); const quantity = quantityMatch ? parseInt(quantityMatch[0]) : 1; ambiguities.push({ originalText: "××•×¦×¨ ×œ× ×–×•×”×” ×‘×•×•×“××•×ª", quantity: quantity, options: potentialMatches }); } if (items.length > 0) setDetectedOrder(prev => [...prev, ...items]); if (ambiguities.length > 0) setAmbiguousItems(prev => [...prev, ...ambiguities]); };
  const resolveAmbiguity = (ambiguousIdx: number, selectedProduct: Product) => { const ambItem = ambiguousItems[ambiguousIdx]; const newItem: OrderItem = { name: selectedProduct.name, quantity: ambItem.quantity, sku: selectedProduct.sku, productId: selectedProduct.id }; setDetectedOrder(prev => [...prev, newItem]); setAmbiguousItems(prev => prev.filter((_, i) => i !== ambiguousIdx)); };
  const removeAmbiguity = (index: number) => { setAmbiguousItems(prev => prev.filter((_, i) => i !== index)); };

  const handleAddProduct = async () => { if (!newProdName || !newProdSku) { alert("×—×•×‘×” ×œ××œ× ×©× ×•××§×´×˜"); return; } await addDoc(collection(db, "inventory"), { name: newProdName, sku: newProdSku, category: newProdCategory || "×›×œ×œ×™", stock: parseInt(newProdStock) || 0, imageUrl: newProdImage || "", }); setShowAddProductModal(false); setNewProdName(""); setNewProdSku(""); setNewProdCategory(""); setNewProdStock(""); setNewProdImage(""); alert("××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!"); };
  const addItemFromSmartList = (product: Product, quantity: number) => { if (quantity <= 0) return; const existingItemIndex = detectedOrder.findIndex(item => item.sku === product.sku); const updatedOrder = [...detectedOrder]; if (existingItemIndex > -1) { updatedOrder[existingItemIndex].quantity += quantity; } else { updatedOrder.push({ name: product.name, sku: product.sku, quantity: quantity, productId: product.id }); } setDetectedOrder(updatedOrder); };
  const handleSendReply = async () => { if (!reply.trim() || !selectedClientId) return; const messageData: any = { text: reply, sender: "server", timestamp: new Date(), type: "text", isInternal: isInternalMode }; if (currentUser) { messageData.staffName = currentUser.name; messageData.staffRole = currentUser.role; messageData.staffAvatar = currentUser.avatarUrl; } await addDoc(collection(db, `chats/${selectedClientId}/messages`), messageData); setReply(""); setChatSuggestions([]); };
  const handleAddClient = async () => { if (!newClientName.trim()) return; const newId = newClientNumber.trim() + "_" + Math.floor(Math.random() * 1000); await setDoc(doc(db, "clients", newId), { name: newClientName, clientNumber: newClientNumber, projectName: newProjectName || "", phone: newClientPhone || "", avatarUrl: newClientAvatar || "", createdAt: new Date() }); setShowAddClientModal(false); setSelectedClientId(newId); };
  const handleAddStaff = async () => { if (!newStaffName.trim() || !newStaffEmail.trim()) { alert("×—×•×‘×” ×œ××œ× ×©× ×•××™××™×™×œ"); return; } const newId = "staff_" + Math.floor(100000 + Math.random() * 900000); try { await setDoc(doc(db, "staff", newId), { name: newStaffName, role: newStaffRole, phone: newStaffPhone, email: newStaffEmail.toLowerCase(), password: "123456", isFirstLogin: true, avatarUrl: newStaffAvatar, createdAt: new Date() }); setShowAddStaffModal(false); setNewStaffName(""); setNewStaffRole(""); setNewStaffPhone(""); setNewStaffEmail(""); setNewStaffAvatar(""); alert(`×¢×•×‘×“ × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n××©×ª××©: ${newStaffEmail}\n×¡×™×¡××”: 123456`); } catch (e) { console.error(e); alert("×©×’×™××” ×‘×™×¦×™×¨×ª ××™×© ×¦×•×•×ª"); } };
  const copyLink = (clientId: string) => { navigator.clipboard.writeText(`${window.location.origin}/magic/${clientId}`); alert("×”×§×™×©×•×¨ ×”×•×¢×ª×§!"); };
  const copyStaffLink = (staffId: string) => { navigator.clipboard.writeText(`${window.location.origin}/staff/login`); alert("×”×§×™×©×•×¨ ×œ×“×£ ×”×›× ×™×¡×” ×”×•×¢×ª×§!"); };
  const handleApproveOrder = async () => { if (!selectedClientId || detectedOrder.length === 0) return; const clientName = clients.find(c => c.id === selectedClientId)?.name || "×œ×§×•×—"; await addDoc(collection(db, "orders"), { clientId: selectedClientId, clientName: clientName, items: detectedOrder, status: "new", timestamp: new Date() }); const summary = detectedOrder.map(item => `${item.quantity} ${item.name}`).join(", "); await addDoc(collection(db, `chats/${selectedClientId}/messages`), { text: `âœ… ×”×–×× ×” × ×§×œ×˜×”!\n${summary}`, sender: "server", timestamp: new Date(), type: "text" }); setDetectedOrder([]); alert("×”×”×–×× ×” × ×©××¨×” ×•××•×¤×™×¢×” ×›×¡×˜×•×¨×™ ×¤×¢×™×œ!"); };

  const openStatusStory = (order: SavedOrder) => { setSelectedStoryOrder(order); setShowStatusModal(true); };
  const updateStoryStatus = async (newStatus: string) => { if (!selectedStoryOrder) return; await updateDoc(doc(db, "orders", selectedStoryOrder.id), { status: newStatus }); let msg = ""; if (newStatus === "processing") msg = "ğŸ‘· ×”×”×–×× ×” ×©×œ×š ×‘×œ×™×§×•×˜"; if (newStatus === "shipped") msg = "ğŸšš ×”×”×–×× ×” ×™×¦××” ×œ×“×¨×š!"; if (newStatus === "delivered") msg = "âœ… ×”×”×–×× ×” × ××¡×¨×”."; if (msg) { await addDoc(collection(db, `chats/${selectedStoryOrder.clientId}/messages`), { text: msg, sender: "server", timestamp: new Date(), type: "text" }); } setShowStatusModal(false); };
  const getStoryColor = (status: string) => { if (status === "new") return "from-blue-500 to-blue-300"; if (status === "processing") return "from-orange-500 to-yellow-300"; if (status === "shipped") return "from-purple-500 to-pink-300"; return "from-gray-300 to-gray-400"; };
  
  const handleSignAndSave = async () => { if (!pdfToSign || !currentOrderIdForSign) return; setIsSigning(true); try { const pdfBytes = await pdfToSign.arrayBuffer(); const pdfDoc = await PDFDocument.load(pdfBytes); const fontUrl = window.location.origin + '/rubik.ttf'; let fontBytes; try { fontBytes = await fetch(fontUrl).then(res => { if (!res.ok) throw new Error("Missing font"); return res.arrayBuffer(); }); } catch (e) { alert("×©×’×™××”: ×¤×•× ×˜ ×—×¡×¨."); setIsSigning(false); return; } pdfDoc.registerFontkit(fontkit); const hebrewFont = await pdfDoc.embedFont(fontBytes); const pages = pdfDoc.getPages(); const firstPage = pages[0]; const smartDraw = (text: string, x: number, y: number) => { if (!text) return; const hasHebrew = /[\u0590-\u05FF]/.test(text); const finalText = hasHebrew ? text.split('').reverse().join('') : text; firstPage.drawText(finalText, { x, y, size: 10, font: hebrewFont, color: rgb(0, 0, 0) }); }; smartDraw(logistics.unloadingStart, 390, 215); smartDraw(logistics.unloadingEnd, 490, 215); smartDraw(logistics.waitingStart, 90, 215); smartDraw(logistics.waitingEnd, 160, 215); smartDraw(logistics.craneStart, 390, 195); smartDraw(logistics.craneEnd, 490, 195); if (logistics.craneType === "15m") smartDraw("X", 265, 195); if (logistics.craneType === "9m") smartDraw("X", 175, 195); const retY = 168; smartDraw(logistics.retBigBag, 530, retY); smartDraw(logistics.retBarrel, 460, retY); smartDraw(logistics.retPallet, 390, retY); smartDraw(logistics.retBlockPallet, 290, retY); smartDraw(logistics.retOther, 160, retY); const credY = 148; smartDraw(logistics.credBigBag, 530, credY); smartDraw(logistics.credBarrel, 460, credY); smartDraw(logistics.credPallet, 390, credY); smartDraw(logistics.credBlockPallet, 290, credY); smartDraw(logistics.credOther, 160, credY); smartDraw(logistics.repName, 250, 60); const signatureDataUrl = sigCanvas.current.getTrimmedCanvas().toDataURL('image/png'); const signatureImageBytes = await fetch(signatureDataUrl).then(res => res.arrayBuffer()); const signatureImage = await pdfDoc.embedPng(signatureImageBytes); firstPage.drawImage(signatureImage, { x: 60, y: 35, width: 100, height: 50 }); const signedPdfBytes = await pdfDoc.save(); const base64Pdf = Buffer.from(signedPdfBytes).toString('base64'); const response = await fetch(GAS_URL, { redirect: "follow", method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ file: base64Pdf, filename: `signed_delivery_${currentOrderIdForSign}.pdf`, mimeType: "application/pdf" }) }); const data = await response.json(); if (data.status === "success") { await updateDoc(doc(db, "orders", currentOrderIdForSign), { signedPdfUrl: data.url, status: "delivered" }); alert("×”××¡××š × ×—×ª× ×•×”× ×ª×•× ×™× ××•×œ××• ×‘×”×¦×œ×—×”!"); setShowSignModal(false); } else { throw new Error("Upload failed on server"); } } catch (error) { console.error(error); alert("×©×’×™××” ×‘×ª×”×œ×™×š: " + error); } finally { setIsSigning(false); } };
  const openSignModal = (orderId: string) => { setCurrentOrderIdForSign(orderId); setPdfToSign(null); setShowSignModal(true); };
  const updateOrderStatus = async (orderId: string, clientId: string, newStatus: string) => { await updateDoc(doc(db, "orders", orderId), { status: newStatus }); let statusMsg = ""; if (newStatus === "shipped") statusMsg = "ğŸšš ×”×”×–×× ×” ×‘×“×¨×š"; if (statusMsg) await addDoc(collection(db, `chats/${clientId}/messages`), { text: statusMsg, sender: "server", timestamp: new Date(), type: "text" }); };
  const handleLogisticsChange = (field: string, value: string) => { setLogistics(prev => ({ ...prev, [field]: value })); };
  const updateQuantity = (index: number, newQty: number) => { const updated = [...detectedOrder]; updated[index].quantity = newQty; setDetectedOrder(updated); };
  const removeItem = (index: number) => { const updated = detectedOrder.filter((_, i) => i !== index); setDetectedOrder(updated); };

  return (
    <div className="flex h-screen bg-gray-50 overflow-hidden text-gray-900 font-sans" dir="rtl">
      {/* ×¡×¨×’×œ ×¦×“ */}
      <div className="w-1/4 bg-white border-l border-gray-300 flex flex-col hidden md:flex z-20 shadow-lg">
        <div className="p-4 bg-[#008069] text-white flex justify-between items-center shadow-md">
            <div className="flex items-center gap-2">
                <div className="relative">{currentUser?.avatarUrl ? <img src={currentUser.avatarUrl} className="w-10 h-10 rounded-full border-2 border-white"/> : <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><User/></div>}<div className="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border border-white"></div></div>
                <div><div className="font-bold text-sm">{currentUser ? currentUser.name : "×× ×”×œ ××¢×¨×›×ª"}</div><div className="text-xs text-green-100">{currentUser ? currentUser.role : "Admin"}</div></div>
            </div>
            <button onClick={handleLogout} title="×™×¦×™××”"><LogOut size={18} /></button>
        </div>
        <div className="p-3 bg-gray-100 border-b flex justify-between items-center text-gray-600"><span className="font-bold text-sm flex gap-2"><Users size={16}/> ×œ×§×•×—×•×ª</span><button onClick={() => setShowAddClientModal(true)} className="hover:bg-gray-200 p-1 rounded"><Plus size={18}/></button></div>
        <div className="flex-1 overflow-y-auto">{clients.map(client => (<div key={client.id} onClick={() => setSelectedClientId(client.id)} className={`p-4 border-b cursor-pointer hover:bg-green-50 transition-all group ${selectedClientId === client.id ? 'bg-green-100 border-r-4 border-r-green-600' : ''}`}><div className="flex justify-between items-center w-full"><div className="flex items-center gap-3">{client.avatarUrl ? <img src={client.avatarUrl} className="w-8 h-8 rounded-full object-cover"/> : <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-xs">{client.name[0]}</div>}<div><div className="font-bold text-sm">{client.name}</div><div className="text-xs text-gray-500">{client.projectName}</div></div></div><button onClick={(e) => { e.stopPropagation(); copyLink(client.id); }} className="text-gray-400 hover:text-blue-600 bg-white p-2 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-all border border-gray-100 hover:border-blue-200" title="×”×¢×ª×§ ×œ×™× ×§ ×§×¡× ×œ×œ×§×•×—"><Link size={14}/></button></div></div>))}</div>
      </div>
export default function Page() {
  return (
    <div className="bg-red-500 text-white p-10 text-3xl">
      TAILWIND TEST
    </div>
  );
}

      {/* ××¨×›×– */}
      <div className="flex-1 flex flex-col bg-[#efeae2] relative">
         {/* ×¡×˜×•×¨×™×– */}
         <div className="bg-white border-b border-gray-200 p-4 shadow-sm z-10">
             <div className="flex items-center gap-4 overflow-x-auto no-scrollbar pb-2">
                 <div className="flex flex-col items-center gap-1 min-w-[60px] cursor-pointer" onClick={() => setActiveTab("orders")}>
                     <div className="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center border-2 border-dashed border-gray-300 text-gray-400"><List/></div>
                     <span className="text-[10px] text-gray-500 font-bold">×›×œ ×”×”×–×× ×•×ª</span>
                 </div>
                 {ordersList.filter(o => o.status !== 'delivered').map(order => (
                     <div key={order.id} onClick={() => openStatusStory(order)} className="flex flex-col items-center gap-1 cursor-pointer group animate-in slide-in-from-bottom-2 fade-in duration-500">
                         <div className={`w-14 h-14 rounded-full p-[3px] bg-gradient-to-tr ${getStoryColor(order.status)} animate-pulse group-hover:scale-105 transition-transform`}>
                             <div className="w-full h-full bg-white rounded-full p-[2px] overflow-hidden">
                                 <div className="w-full h-full bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-700 text-sm border">
                                     {order.clientName.charAt(0)}
                                 </div>
                             </div>
                         </div>
                         <span className="text-[10px] font-bold text-gray-700 truncate w-16 text-center">{order.clientName}</span>
                     </div>
                 ))}
             </div>
         </div>

         {/* ×›×•×ª×¨×ª */}
         <div className="bg-white/80 backdrop-blur-md p-2 shadow-sm flex justify-between items-center z-10 px-6 border-b border-gray-100">
             <div className="flex items-center gap-4">
                 <div className="font-bold text-lg">{selectedClientId ? clients.find(c => c.id === selectedClientId)?.name : (activeTab === "inventory" ? "× ×™×”×•×œ ××œ××™" : "×“×©×‘×•×¨×“")}</div>
                 {activeTab === "chat" && !soundEnabled && (<button onClick={enableSound} className="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded-full flex items-center gap-1 animate-pulse" title="×”×¤×¢×œ ×¡××•× ×“"><BellOff size={10}/> ×©×§×˜</button>)}
             </div>
             <div className="flex bg-gray-100 p-1 rounded-lg">
                <button onClick={() => setActiveTab("chat")} className={`px-3 py-1 rounded-md text-xs font-bold flex gap-2 ${activeTab === "chat" ? "bg-white text-green-700 shadow" : "text-gray-500"}`}><MessageSquare size={14}/> ×¦'××˜</button>
                <button onClick={() => setActiveTab("orders")} className={`px-3 py-1 rounded-md text-xs font-bold flex gap-2 ${activeTab === "orders" ? "bg-white text-blue-700 shadow" : "text-gray-500"}`}><List size={14}/> ×”×–×× ×•×ª</button>
                <button onClick={() => setActiveTab("inventory")} className={`px-3 py-1 rounded-md text-xs font-bold flex gap-2 ${activeTab === "inventory" ? "bg-white text-orange-700 shadow" : "text-gray-500"}`}><Box size={14}/> ××œ××™</button>
                <button onClick={() => setActiveTab("team")} className={`px-3 py-1 rounded-md text-xs font-bold flex gap-2 ${activeTab === "team" ? "bg-white text-purple-700 shadow" : "text-gray-500"}`}><UserCog size={14}/> ×¦×•×•×ª</button>
             </div>
         </div>
         
         {activeTab === "chat" && selectedClientId && (
            <>
                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')] bg-repeat opacity-100">
                    {messages.map((m) => {
                        const isClient = m.sender === 'client';
                        const currentClient = clients.find(c => c.id === selectedClientId);
                        return (
                            <div key={m.id} className={`max-w-[70%] p-2 rounded-lg text-sm shadow-md font-medium relative ${isClient ? 'bg-white self-start rounded-tl-none' : m.isInternal ? 'bg-yellow-50 border border-yellow-400 self-end rounded-tr-none' : 'bg-[#d9fdd3] self-end rounded-tr-none'} ${m.text.includes("â­") ? 'border-2 border-orange-300 bg-orange-50' : ''}`}>
                                <div className={`flex items-center gap-1.5 mb-1 pb-1 border-b border-black/5 ${isClient ? 'flex-row' : 'flex-row-reverse'}`}>
                                    {isClient ? (currentClient?.avatarUrl ? <img src={currentClient.avatarUrl} className="w-5 h-5 rounded-full object-cover"/> : <div className="w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center text-[10px]">{currentClient?.name[0]}</div>) : (m.staffAvatar ? <img src={m.staffAvatar} className="w-5 h-5 rounded-full object-cover"/> : <div className="w-5 h-5 bg-green-200 rounded-full flex items-center justify-center text-[10px]"><User size={12}/></div>)}
                                    <span className={`text-[10px] font-bold flex items-center gap-1 ${isClient ? 'text-gray-600' : (m.isInternal ? 'text-yellow-700' : 'text-green-800')}`}>{m.isInternal && <Lock size={10} />} {isClient ? currentClient?.name : (m.staffName || "×¡×‘×Ÿ ××¢×¨×›×•×ª")}</span>
                                </div>
                                <div className="px-1">{m.type === 'text' && m.text}</div>
                                {m.type === 'image' && m.fileUrl && (<div className="flex flex-col gap-1"><img src={m.fileUrl} alt="×ª××•× ×”" referrerPolicy="no-referrer" className="rounded max-h-48 w-full object-cover"/><a href={m.fileUrl} target="_blank" className="text-xs text-blue-600 underline text-center">×¤×ª×— ×ª××•× ×” ××§×•×¨×™×ª</a></div>)}
                                {m.type === 'file' && m.fileUrl && (<div className="flex gap-2 mt-2"><a href={m.fileUrl} target="_blank" className="flex items-center gap-2 bg-gray-100 p-2 rounded hover:bg-gray-200 text-blue-700 text-xs font-bold"><FileText size={16}/> ×”×•×¨×“</a><button onClick={() => setPreviewPdf(m.fileUrl!)} className="bg-blue-100 text-blue-800 p-2 rounded text-xs font-bold hover:bg-blue-200">×”×¦×’</button></div>)}
                                {m.type === 'location' && m.location && (<div className="flex flex-col gap-2 mt-1"><span className="flex items-center gap-1 font-bold"><MapPin size={16}/> ××™×§×•×:</span><a href={`https://waze.com/ul?ll=${m.location.lat},${m.location.lng}&navigate=yes`} target="_blank" className="bg-blue-500 text-white px-3 py-2 rounded-lg shadow font-bold text-center hover:bg-blue-600">ğŸš— × ×•×•×˜ ×œ×œ×§×•×— ×‘-Waze</a></div>)}
                                <div className={`text-[9px] text-gray-400 mt-1 text-left`}>{m.timestamp?.seconds ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</div>
                            </div>
                        );
                    })}
                    <div ref={messagesEndRef} />
                </div>
                
                <div className={`bg-white p-3 flex gap-2 border-t transition-colors ${isInternalMode ? 'bg-yellow-50' : ''} relative`}>
                    
                    {/* ğŸ”¥ ×—×œ×•×Ÿ ×”×¦×¢×•×ª (Autocomplete) ğŸ”¥ */}
                    {chatSuggestions.length > 0 && (
                        <div className="absolute bottom-16 left-2 right-2 bg-white border border-gray-200 rounded-xl shadow-xl z-20 max-h-60 overflow-y-auto animate-in slide-in-from-bottom-2">
                            <div className="bg-gray-50 px-3 py-1 text-[10px] text-gray-500 font-bold border-b">×”×¦×¢×•×ª ××•×¦×¨×™×</div>
                            {chatSuggestions.map(prod => (
                                <div key={prod.id} onClick={() => selectChatSuggestion(prod)} className="p-3 border-b last:border-0 hover:bg-blue-50 cursor-pointer flex items-center gap-3 transition-colors">
                                    {prod.imageUrl ? <img src={prod.imageUrl} className="w-8 h-8 rounded object-cover"/> : <div className="w-8 h-8 bg-gray-100 rounded flex items-center justify-center"><Box size={14}/></div>}
                                    <div className="flex-1"><div className="text-sm font-bold text-gray-800">{prod.name}</div><div className="text-xs text-gray-500">{prod.sku}</div></div>
                                    <Plus size={16} className="text-blue-500"/>
                                </div>
                            ))}
                        </div>
                    )}

                    <button onClick={() => setIsInternalMode(!isInternalMode)} className={`p-2 rounded-full transition-all ${isInternalMode ? 'bg-yellow-400 text-yellow-900 rotate-180' : 'bg-gray-100 text-gray-500'}`} title={isInternalMode ? "××¦×‘ ×¡××•×™ ×¤×¢×™×œ" : "×”×¤×¢×œ ××¦×‘ ×¡××•×™"} >{isInternalMode ? <EyeOff size={20}/> : <Eye size={20}/>}</button>
                    <input value={reply} onChange={(e) => handleChatInputChange(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSendReply()} className={`flex-1 p-3 rounded-full outline-none border focus:ring-1 ${isInternalMode ? 'bg-white border-yellow-400 focus:border-yellow-500 focus:ring-yellow-500 placeholder-yellow-600' : 'bg-gray-50 border-gray-200 focus:border-green-500'}`} placeholder={isInternalMode ? `ğŸ”’ ×”×•×“×¢×” ×¤× ×™××™×ª...` : `×”×’×‘ ×‘×ª×•×¨ ${currentUser?.name || '×× ×”×œ'}...`} />
                    <button onClick={handleSendReply} className={`p-3 rounded-full text-white shadow-lg transition-colors ${isInternalMode ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-[#008069] hover:bg-[#006a57]'}`}>{isInternalMode ? <Lock size={20}/> : <Send size={20} />}</button>
                </div>
            </>
         )}

         {/* ×©××¨ ×”×œ×©×•× ×™×•×ª */}
         {activeTab === "inventory" && (<div className="flex-1 overflow-y-auto p-8 bg-gray-50"><div className="max-w-5xl mx-auto"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold flex items-center gap-2"><Box className="text-orange-600"/> × ×™×”×•×œ ××œ××™</h2><button onClick={() => setShowAddProductModal(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2 shadow-lg"><Plus size={20}/> ×”×•×¡×£ ××•×¦×¨</button></div><div className="grid grid-cols-1 gap-3"><div className="grid grid-cols-12 gap-4 bg-gray-200 p-3 rounded-t-lg font-bold text-gray-600 text-sm"><div className="col-span-1">×ª××•× ×”</div><div className="col-span-2">××§"×˜</div><div className="col-span-4">×©× ×”××•×¦×¨</div><div className="col-span-2">×§×˜×’×•×¨×™×”</div><div className="col-span-2">××œ××™</div><div className="col-span-1">×¤×¢×•×œ×•×ª</div></div>{inventory.map(prod => (<div key={prod.id} className="grid grid-cols-12 gap-4 bg-white p-3 border-b border-gray-100 items-center hover:bg-orange-50 transition text-sm group"><div className="col-span-1 relative">{prod.imageUrl ? <img src={prod.imageUrl} className="w-10 h-10 rounded-md object-cover border group-hover:scale-150 transition-transform origin-left z-10"/> : <div className="w-10 h-10 bg-gray-100 rounded-md flex items-center justify-center"><Box size={16} className="text-gray-400"/></div>}</div><div className="col-span-2 font-mono text-gray-500">{prod.sku}</div><div className="col-span-4 flex flex-col"><span className="font-bold text-gray-800">{prod.name}</span><div className="flex gap-1 mt-1">{prod.name.split(' ').filter(w=>w.length>1).map((w,i) => <span key={i} className="text-[10px] bg-blue-50 text-blue-600 px-1 rounded">{w}</span>)}</div></div><div className="col-span-2"><span className="bg-gray-100 px-2 py-1 rounded-md text-xs">{prod.category}</span></div><div className="col-span-2 font-bold flex items-center gap-2">{prod.stock} ×™×—' {prod.stock < 10 && <AlertTriangle size={12} className="text-red-500"/>}</div><div className="col-span-1 text-center"><button className="text-gray-400 hover:text-red-500" onClick={async () => { if(confirm("×œ××—×•×§?")) await deleteDoc(doc(db, "inventory", prod.id)) }}><Trash2 size={16}/></button></div></div>))}</div></div></div>)}
         {activeTab === "team" && (<div className="flex-1 overflow-y-auto p-8 bg-gray-50"><div className="max-w-4xl mx-auto"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold flex items-center gap-2"><UserCog className="text-purple-600"/> × ×™×”×•×œ ×”×¦×•×•×ª</h2><button onClick={() => setShowAddStaffModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2 shadow-lg"><Plus size={20}/> ×”×•×¡×£ ××™×© ×¦×•×•×ª</button></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{staffMembers.map(staff => (<div key={staff.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4 relative group">{staff.avatarUrl ? <img src={staff.avatarUrl} className="w-16 h-16 rounded-full object-cover border-2 border-purple-100"/> : <div className="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center font-bold text-2xl text-purple-600">{staff.name[0]}</div>}<div><div className="font-bold text-lg">{staff.name}</div><div className="text-sm text-purple-600 font-bold bg-purple-50 px-2 py-0.5 rounded-md w-fit mb-1">{staff.role}</div><div className="text-xs text-gray-500 flex flex-col gap-1"><span className="flex items-center gap-1"><Phone size={12}/> {staff.phone}</span><span className="flex items-center gap-1"><Mail size={12}/> {staff.email}</span></div></div><button onClick={() => copyStaffLink(staff.id)} className="absolute top-4 left-4 text-gray-400 hover:text-purple-600 bg-gray-50 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all" title="×”×¢×ª×§ ×œ×™× ×§ ×›× ×™×¡×” ×œ×¦×•×•×ª"><Copy size={18}/></button></div>))}</div></div></div>)}
         {activeTab === "orders" && (<div className="flex-1 overflow-y-auto p-6 bg-gray-50"><h3 className="text-2xl font-bold mb-6 text-gray-800">ğŸ“‹ ×¨×™×›×•×– ×”×–×× ×•×ª</h3><div className="space-y-4">{ordersList.map(order => (<div key={order.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><div className="flex justify-between items-start mb-4 border-b pb-3"><div><div className="font-bold text-lg text-gray-900">{order.clientName}</div><div className="text-sm text-gray-500">{order.timestamp?.seconds ? new Date(order.timestamp.seconds * 1000).toLocaleDateString() : ''}</div></div><div className={`px-3 py-1 rounded-full text-xs font-bold border ${STATUS_COLORS[order.status]}`}>{STATUS_LABELS[order.status]}</div></div><div className="bg-gray-50 p-3 rounded-lg mb-4">{order.items.map((item, idx) => (<div key={idx} className="flex justify-between text-sm py-1 border-b last:border-0 border-gray-200"><span className="font-medium text-gray-800">{item.name} <span className="text-xs text-gray-400">({item.sku})</span></span><span className="font-bold">{item.quantity} ×™×—'</span></div>))}</div><div className="flex gap-2 justify-end items-center border-t pt-3">{order.signedPdfUrl ? (<a href={order.signedPdfUrl} target="_blank" className="flex items-center gap-2 text-green-700 bg-green-50 px-3 py-2 rounded-lg font-bold border border-green-200 hover:bg-green-100"><FileSignature size={18} /> ×¦×¤×” ×‘×ª×¢×•×“×” ×—×ª×•××”</a>) : (<button onClick={() => openSignModal(order.id)} className="flex items-center gap-2 text-blue-700 bg-blue-50 px-3 py-2 rounded-lg font-bold border border-blue-200 hover:bg-blue-100"><FileText size={18} /> ×™×™×‘× ×•×”×—×ª× × ×”×’</button>)}<div className="w-px h-6 bg-gray-300 mx-2"></div><button onClick={() => updateOrderStatus(order.id, order.clientId, "processing")} className="text-xs px-3 py-2 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded-md font-bold flex items-center gap-1"><Package size={14}/> ×‘×˜×™×¤×•×œ</button><button onClick={() => updateOrderStatus(order.id, order.clientId, "shipped")} className="text-xs px-3 py-2 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-md font-bold flex items-center gap-1"><Truck size={14}/> ×™×¦× ×œ××©×œ×•×—</button></div></div>))}</div></div>)}
      </div>

      {/* ×¤×× ×œ ×˜×™×•×˜×” ×¢× ××–×•×¨ ×”×ª×œ×‘×˜×•×™×•×ª */}
      {activeTab === "chat" && selectedClientId && (
          <div className="w-1/4 bg-white border-r border-gray-300 p-5 flex flex-col shadow-2xl z-20">
            <h3 className="font-extrabold text-xl mb-4 flex items-center gap-2 text-gray-800 border-b pb-3"><Package className="text-orange-600" /> ×˜×™×•×˜×” ×—×“×©×”</h3>
            <button onClick={() => setShowSmartListModal(true)} className="w-full mb-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-lg flex items-center justify-center gap-2 border border-gray-300 shadow-sm transition-all"><Edit size={16}/> ×¢×¨×•×š / ×”×•×¡×£ ×¤×¨×™×˜×™×</button>
            {ambiguousItems.length > 0 && (
                <div className="mb-4 bg-yellow-50 border border-yellow-200 rounded-xl p-3 shadow-inner animate-in fade-in slide-in-from-top-2">
                    <div className="flex items-center gap-2 text-yellow-800 font-bold text-sm mb-2"><HelpCircle size={16}/> × ×“×¨×© ×‘×™×¨×•×¨</div>
                    {ambiguousItems.map((amb, idx) => (
                        <div key={idx} className="mb-3 last:mb-0">
                            <p className="text-xs text-gray-600 mb-1">×œ××™×–×” <b>"{amb.originalText}"</b> ×”×›×•×•× ×”? (×›××•×ª: {amb.quantity})</p>
                            <div className="flex flex-wrap gap-1">
                                {amb.options.map(opt => (
                                    <button key={opt.id} onClick={() => resolveAmbiguity(idx, opt)} className="text-xs bg-white border border-yellow-300 hover:bg-yellow-100 px-2 py-1 rounded-md shadow-sm transition-colors text-yellow-900">{opt.name}</button>
                                ))}
                                <button onClick={() => removeAmbiguity(idx)} className="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-md text-gray-600"><X size={12}/></button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            {detectedOrder.length > 0 ? (
                <div className="flex-1 flex flex-col">
                    <div className="space-y-3 flex-1 overflow-y-auto">{detectedOrder.map((item, idx) => (<div key={idx} className="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm group"><div><div className="font-bold text-gray-900">{item.name}</div><div className="text-xs text-gray-500">{item.sku}</div></div><div className="flex items-center gap-2"><input type="number" value={item.quantity} onChange={(e) => updateQuantity(idx, parseInt(e.target.value))} className="w-14 text-center border rounded py-1 font-bold outline-none focus:ring-1 ring-orange-500"/><button onClick={() => removeItem(idx)} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button></div></div>))}</div>
                    <button onClick={handleApproveOrder} className="mt-4 w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-green-700 flex items-center justify-center gap-2"><CheckCircle size={20}/> ××©×¨ ×”×–×× ×”</button>
                </div>
            ) : (ambiguousItems.length === 0 && <div className="text-center text-gray-400 mt-20"><Package size={48} className="mx-auto opacity-20 mb-2"/><p>××™×Ÿ ×˜×™×•×˜×” ×¤×¢×™×œ×”</p></div>)}
          </div>
      )}
      
      {/* ××•×“×œ×™× */}
      {showStatusModal && selectedStoryOrder && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-in fade-in zoom-in-95">
              <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm relative">
                  <button onClick={() => setShowStatusModal(false)} className="absolute top-4 left-4 text-gray-400 hover:text-red-500"><X size={24}/></button>
                  <div className="text-center mb-6">
                      <div className="text-sm text-gray-500 font-bold mb-1">×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×–×× ×”</div>
                      <div className="text-2xl font-bold text-gray-800">{selectedStoryOrder.clientName}</div>
                      <div className="text-xs text-gray-400 mt-1">{new Date(selectedStoryOrder.timestamp?.seconds * 1000).toLocaleString()}</div>
                  </div>
                  <div className="space-y-3">
                      <button onClick={() => updateStoryStatus("processing")} className="w-full p-4 rounded-xl bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold flex items-center gap-3 transition-all"><Package/> ×‘×œ×™×§×•×˜ (×‘×”×›× ×”)</button>
                      <button onClick={() => updateStoryStatus("shipped")} className="w-full p-4 rounded-xl bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold flex items-center gap-3 transition-all"><Truck/> ×™×¦× ×œ×“×¨×š (××©×œ×•×—)</button>
                      <button onClick={() => updateStoryStatus("delivered")} className="w-full p-4 rounded-xl bg-green-100 hover:bg-green-200 text-green-800 font-bold flex items-center gap-3 transition-all"><CheckCircle/> × ××¡×¨ ×œ×œ×§×•×— (×¡×™×•×)</button>
                  </div>
              </div>
          </div>
      )}

      {showAddProductModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md"><h3 className="text-xl font-bold mb-4 flex items-center gap-2 border-b pb-2"><Box className="text-orange-600"/> ×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©</h3><div className="space-y-3"><div className="grid grid-cols-2 gap-3"><input className="border p-2 rounded" placeholder="××§×´×˜ (×œ××©×œ 80010)" value={newProdSku} onChange={e => setNewProdSku(e.target.value)}/><input className="border p-2 rounded" placeholder="×§×˜×’×•×¨×™×” (×œ××©×œ ×’×‘×¡)" value={newProdCategory} onChange={e => setNewProdCategory(e.target.value)}/></div><input className="w-full border p-2 rounded" placeholder="×©× ××•×¦×¨ ××œ× (×œ××©×œ: ×œ×•×— ×’×‘×¡ ×™×¨×•×§ 12 ××´×)" value={newProdName} onChange={e => setNewProdName(e.target.value)}/><input className="w-full border p-2 rounded" placeholder="×›××•×ª ×‘××œ××™" type="number" value={newProdStock} onChange={e => setNewProdStock(e.target.value)}/><input className="w-full border p-2 rounded" placeholder="×§×™×©×•×¨ ×œ×ª××•× ×” (URL)" value={newProdImage} onChange={e => setNewProdImage(e.target.value)}/></div><div className="flex gap-3 mt-6"><button onClick={handleAddProduct} className="flex-1 bg-orange-600 text-white py-2 rounded-lg font-bold hover:bg-orange-700 shadow-lg">×©××•×¨ ××•×¦×¨</button><button onClick={() => setShowAddProductModal(false)} className="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button></div></div></div>)}
      {showSmartListModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col h-[80vh] overflow-hidden"><div className="p-4 bg-gray-100 border-b flex flex-col gap-3"><div className="flex justify-between items-center"><h3 className="font-bold text-lg flex items-center gap-2"><List className="text-blue-600"/> ×”×¨×©×™××” ×”×—×›××”</h3><button onClick={() => setShowSmartListModal(false)}><X className="text-gray-400 hover:text-red-500"/></button></div><div className="relative"><Search className="absolute top-3 right-3 text-gray-400" size={20}/><input className="w-full p-3 pr-10 border border-gray-300 rounded-xl focus:ring-2 ring-blue-500 outline-none" placeholder="×—×¤×© ××•×¦×¨ (×œ××©×œ: '×’×‘×¡', '××œ×˜', '80010')..." autoFocus value={smartListSearch} onChange={e => setSmartListSearch(e.target.value)}/></div></div><div className="flex-1 overflow-y-auto p-4 bg-gray-50"><div className="grid grid-cols-1 gap-2">{inventory.filter(p => p.name.includes(smartListSearch) || p.sku.includes(smartListSearch)).map(prod => (<div key={prod.id} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center group hover:border-blue-300 transition-all"><div className="flex items-center gap-4"><div className="relative">{prod.imageUrl ? <img src={prod.imageUrl} className="w-12 h-12 rounded-lg object-cover bg-gray-100 group-hover:scale-150 transition-transform origin-bottom-right shadow-sm z-10 relative"/> : <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><Box/></div>}</div><div><div className="font-bold text-gray-800">{prod.name}</div><div className="text-xs text-gray-500 flex gap-2"><span>ğŸ·ï¸ {prod.sku}</span><span>ğŸ“¦ {prod.stock} ×‘××œ××™</span></div></div></div><div className="flex items-center gap-3 bg-gray-50 p-1 rounded-lg"><button className="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-gray-600 hover:bg-gray-100" onClick={() => addItemFromSmartList(prod, -1)}><Minus size={16}/></button><span className="font-bold w-6 text-center">{detectedOrder.find(i => i.sku === prod.sku)?.quantity || 0}</span><button className="w-8 h-8 flex items-center justify-center bg-blue-600 rounded shadow-sm text-white hover:bg-blue-700" onClick={() => addItemFromSmartList(prod, 1)}><Plus size={16}/></button></div></div>))}</div></div><div className="p-4 border-t bg-white flex justify-between items-center"><div className="text-sm text-gray-500">×¡×”"×› ×¤×¨×™×˜×™× ×‘×˜×™×•×˜×”: <b>{detectedOrder.reduce((acc, item) => acc + item.quantity, 0)}</b></div><button onClick={() => setShowSmartListModal(false)} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">×¡×™×™× ×•×¡×’×•×¨</button></div></div></div>)}
      {showAddClientModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm"><h3 className="text-xl font-bold mb-4 flex items-center gap-2 border-b pb-2"><User className="text-[#008069]"/> ×”×§××ª ×œ×§×•×—</h3><div className="space-y-3"><div><label className="text-xs font-bold text-gray-500">××¡×¤×¨ ×œ×§×•×— <span className="text-red-500">*</span></label><div className="flex items-center border rounded-lg px-2 bg-gray-50"><Hash size={16} className="text-gray-400"/><input className="w-full p-2 bg-transparent outline-none" placeholder="×œ××©×œ: 5022" value={newClientNumber} onChange={(e) => setNewClientNumber(e.target.value)}/></div></div><div><label className="text-xs font-bold text-gray-500">×©× ×œ×§×•×— <span className="text-red-500">*</span></label><div className="flex items-center border rounded-lg px-2 bg-gray-50"><User size={16} className="text-gray-400"/><input className="w-full p-2 bg-transparent outline-none" placeholder="×©× ×”×§×‘×œ×Ÿ / ×—×‘×¨×”" value={newClientName} onChange={(e) => setNewClientName(e.target.value)}/></div></div><div><label className="text-xs font-bold text-gray-500">×©× ×¤×¨×•×™×§×˜</label><div className="flex items-center border rounded-lg px-2 bg-gray-50"><Briefcase size={16} className="text-gray-400"/><input className="w-full p-2 bg-transparent outline-none" placeholder="×œ××©×œ: ××’×“×œ×™ ×”×™× ×”×ª×™×›×•×Ÿ" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)}/></div></div><div><label className="text-xs font-bold text-gray-500">×˜×œ×¤×•×Ÿ</label><div className="flex items-center border rounded-lg px-2 bg-gray-50"><Phone size={16} className="text-gray-400"/><input className="w-full p-2 bg-transparent outline-none" placeholder="050-0000000" value={newClientPhone} onChange={(e) => setNewClientPhone(e.target.value)}/></div></div><div><label className="text-xs font-bold text-gray-500">×§×™×©×•×¨ ×œ×ª××•× ×”</label><div className="flex items-center border rounded-lg px-2 bg-gray-50"><ImageIcon size={16} className="text-gray-400"/><input className="w-full p-2 bg-transparent outline-none text-xs" placeholder="https://..." value={newClientAvatar} onChange={(e) => setNewClientAvatar(e.target.value)}/></div></div></div><div className="flex gap-3 mt-6"><button onClick={handleAddClient} className="flex-1 bg-[#008069] text-white py-2 rounded-lg font-bold hover:bg-[#006a57] shadow-lg">×©××•×¨ ×•×¦×•×¨</button><button onClick={() => setShowAddClientModal(false)} className="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200">×‘×™×˜×•×œ</button></div></div></div>)}
      {showAddStaffModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm"><h3 className="text-xl font-bold mb-4 flex items-center gap-2 border-b pb-2"><UserCog className="text-purple-600"/> ×”×•×¡×¤×ª ××™×© ×¦×•×•×ª</h3><div className="space-y-3"><input className="w-full p-2 border rounded" placeholder="×©× ××œ× (×œ××©×œ: ×”×¨××œ ×¡×‘×Ÿ)" value={newStaffName} onChange={e => setNewStaffName(e.target.value)}/><input className="w-full p-2 border rounded" placeholder="×ª×¤×§×™×“ (×œ××©×œ: ×× ×›×´×œ)" value={newStaffRole} onChange={e => setNewStaffRole(e.target.value)}/><input className="w-full p-2 border rounded" placeholder="×˜×œ×¤×•×Ÿ" value={newStaffPhone} onChange={e => setNewStaffPhone(e.target.value)}/><input className="w-full p-2 border rounded" placeholder="××™××™×™×œ ×œ×”×ª×—×‘×¨×•×ª" value={newStaffEmail} onChange={e => setNewStaffEmail(e.target.value)}/><input className="w-full p-2 border rounded" placeholder="×œ×™× ×§ ×œ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)" value={newStaffAvatar} onChange={e => setNewStaffAvatar(e.target.value)}/></div><div className="flex gap-3 mt-6"><button onClick={handleAddStaff} className="flex-1 bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700">×©××•×¨</button><button onClick={() => setShowAddStaffModal(false)} className="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold">×‘×™×˜×•×œ</button></div></div></div>)}
      {showSignModal && (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden"><div className="p-4 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold text-lg flex items-center gap-2"><FileSignature className="text-blue-600"/> ×”×©×œ××ª ×ª×¢×•×“×ª ××©×œ×•×—</h3><button onClick={() => setShowSignModal(false)}><X className="text-gray-400 hover:text-red-500"/></button></div><div className="p-6 flex-1 overflow-y-auto flex flex-col gap-6">{!pdfToSign ? (<div className="w-full border-2 border-dashed border-gray-300 rounded-xl p-16 flex flex-col items-center justify-center gap-4 bg-gray-50 hover:bg-blue-50 transition cursor-pointer" onClick={() => document.getElementById('pdf-upload')?.click()}><div className="bg-blue-100 p-4 rounded-full text-blue-600"><FileText size={48}/></div><div className="text-center"><p className="font-bold text-lg">×˜×¢×Ÿ ×ª×¢×•×“×ª ××©×œ×•×— (PDF)</p><p className="text-sm text-gray-500">×œ×—×¥ ×›××Ÿ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ ××§×•××§×¡</p></div><input type="file" id="pdf-upload" accept="application/pdf" className="hidden" onChange={(e) => e.target.files && setPdfToSign(e.target.files[0])} /></div>) : (<div className="flex flex-col gap-6"><div className="flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-lg font-bold border border-green-200 justify-center"><CheckCircle size={16}/> ×”×§×•×‘×¥ × ×˜×¢×Ÿ: {pdfToSign.name}</div><div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm"><h4 className="font-bold text-gray-700 mb-3 border-b pb-1">×–×× ×™ ×¢×‘×•×“×”</h4><div className="grid grid-cols-2 gap-4 mb-4"><div className="flex gap-2 items-center"><span className="w-20">×¤×¨×™×§×”:</span><input type="time" className="border p-1 rounded w-24" value={logistics.unloadingStart} onChange={e => handleLogisticsChange("unloadingStart", e.target.value)} /><ArrowLeftRight size={14}/><input type="time" className="border p-1 rounded w-24" value={logistics.unloadingEnd} onChange={e => handleLogisticsChange("unloadingEnd", e.target.value)} /></div><div className="flex gap-2 items-center"><span className="w-20">×”××ª× ×”:</span><input type="time" className="border p-1 rounded w-24" value={logistics.waitingStart} onChange={e => handleLogisticsChange("waitingStart", e.target.value)} /><ArrowLeftRight size={14}/><input type="time" className="border p-1 rounded w-24" value={logistics.waitingEnd} onChange={e => handleLogisticsChange("waitingEnd", e.target.value)} /></div><div className="flex gap-2 items-center"><span className="w-20">×¢×‘×•×“×ª ×× ×•×£:</span><input type="time" className="border p-1 rounded w-24" value={logistics.craneStart} onChange={e => handleLogisticsChange("craneStart", e.target.value)} /><ArrowLeftRight size={14}/><input type="time" className="border p-1 rounded w-24" value={logistics.craneEnd} onChange={e => handleLogisticsChange("craneEnd", e.target.value)} /></div><div className="flex gap-4 items-center"><span className="font-bold">×¡×•×’ ×× ×•×£:</span><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="crane" checked={logistics.craneType === "9m"} onChange={() => handleLogisticsChange("craneType", "9m")}/> 9 ××˜×¨</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="crane" checked={logistics.craneType === "15m"} onChange={() => handleLogisticsChange("craneType", "15m")}/> 15 ××˜×¨</label></div></div><h4 className="font-bold text-gray-700 mb-3 border-b pb-1">×”×—×–×¨×•×ª (×›××•×ª)</h4><div className="grid grid-cols-5 gap-2 mb-4 text-center"><div><label className="block text-xs">×©×§ ×’×“×•×œ</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.retBigBag} onChange={e => handleLogisticsChange("retBigBag", e.target.value)}/></div><div><label className="block text-xs">×—×‘×™×ª</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.retBarrel} onChange={e => handleLogisticsChange("retBarrel", e.target.value)}/></div><div><label className="block text-xs">××©×˜×—</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.retPallet} onChange={e => handleLogisticsChange("retPallet", e.target.value)}/></div><div><label className="block text-xs">××©×˜×— ×‘×œ×•×§×™×</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.retBlockPallet} onChange={e => handleLogisticsChange("retBlockPallet", e.target.value)}/></div><div><label className="block text-xs">××—×¨</label><input className="border w-full p-1 rounded text-center" value={logistics.retOther} onChange={e => handleLogisticsChange("retOther", e.target.value)}/></div></div><h4 className="font-bold text-gray-700 mb-3 border-b pb-1">×œ×–×™×›×•×™ (×›××•×ª)</h4><div className="grid grid-cols-5 gap-2 mb-4 text-center"><div><label className="block text-xs">×©×§ ×’×“×•×œ</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.credBigBag} onChange={e => handleLogisticsChange("credBigBag", e.target.value)}/></div><div><label className="block text-xs">×—×‘×™×ª</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.credBarrel} onChange={e => handleLogisticsChange("credBarrel", e.target.value)}/></div><div><label className="block text-xs">××©×˜×—</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.credPallet} onChange={e => handleLogisticsChange("credPallet", e.target.value)}/></div><div><label className="block text-xs">××©×˜×— ×‘×œ×•×§×™×</label><input type="number" className="border w-full p-1 rounded text-center" value={logistics.credBlockPallet} onChange={e => handleLogisticsChange("credBlockPallet", e.target.value)}/></div><div><label className="block text-xs">××—×¨</label><input className="border w-full p-1 rounded text-center" value={logistics.credOther} onChange={e => handleLogisticsChange("credOther", e.target.value)}/></div></div><div className="mt-4"><label className="font-bold block mb-1">×©× × ×¦×™×’ ×œ×§×•×— (××§×‘×œ ×”×¡×—×•×¨×”):</label><div className="flex items-center border rounded bg-white px-2"><UserCheck size={16} className="text-gray-400"/><input className="w-full p-2 outline-none" placeholder="×”×§×œ×“ ×©× ×‘×¢×‘×¨×™×ª..." value={logistics.repName} onChange={e => handleLogisticsChange("repName", e.target.value)} /></div></div></div><div className="text-center"><div className="text-sm text-gray-500 mb-2 font-bold">×—×ª×™××ª ×”×œ×§×•×—:</div><div className="border-2 border-gray-800 rounded-lg bg-white shadow-inner mx-auto w-fit relative"><SignatureCanvas ref={sigCanvas} penColor='black' canvasProps={{width: 500, height: 160, className: 'sigCanvas'}} /></div><button onClick={() => sigCanvas.current.clear()} className="text-xs text-red-500 underline mt-1">× ×§×” ×—×ª×™××”</button></div></div>)}</div><div className="p-4 border-t bg-gray-50 flex justify-end gap-3"><button onClick={() => setShowSignModal(false)} className="px-6 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-200">×‘×™×˜×•×œ</button><button onClick={handleSignAndSave} disabled={!pdfToSign || isSigning} className={`px-6 py-2 rounded-lg font-bold text-white flex items-center gap-2 ${!pdfToSign ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-lg'}`}>{isSigning ? <Loader2 className="animate-spin"/> : <Check size={20}/>}{isSigning ? "×¡×™×™× ×•×©××•×¨ ××¡××š" : "×”×˜××¢ ×”×›×œ ×•×©××•×¨"}</button></div></div></div>)}
    </div>
  );
}

